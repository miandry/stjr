<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Pharmacie</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
		<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
		 <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
		 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js"></script>
		 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
		 <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.js"></script>
		 <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table-locale-all.min.js"></script>
		 <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

			<style type="text/css"> .head-blue {
				--bs-table-color: #fff;
				--bs-table-bg: #61BDF6;
			}
			.active > .page-link,
			.page-link.active,
			.my-blue {
				background-color: #61BDF6 !important;
				border-color: #fff !important;
				color: #fff !important;
			}
			.bootstrap-table .fixed-table-container .fixed-table-body {
				overflow-x: hidden;
			}
			.body-front {
				background-color: aliceblue;
			}
			.main-front {
				background-color: white;
				padding: 15px;
			}
			.select2-container .select2-selection--single {
				height: 37px;
				margin-top: 4px;
				padding: 0.375rem 0.75rem;
				font-size: 1rem;
				font-weight: 400;
				line-height: 1.5;
				color: var(--bs-body-color);
				-webkit-appearance: none;
				-moz-appearance: none;
				appearance: none;
				background-color: var(--bs-body-bg);
				background-clip: padding-box;
				border: var(--bs-border-width) solid var(--bs-border-color);
				border-radius: var(--bs-border-radius);
				transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
			}
			.select2-container--default .select2-selection--single .select2-selection__arrow {
				top: 9px;
				right: 8px;
			}
		</style>
	</head>
	<body class="body-front">
		{%  set conditions = {
            'type': 'article'
        }
   %}
		{% set articles = node_parser_by_properties(conditions)%}
		{%  set condition2 = {
        'type': 'client'
         }
     %}
		{% set clients = node_parser_by_properties(condition2)%}


		{% set params = get_parameter() %}


		<div class="container pt-5">
      <div class="d-flex align-items-center">
        <img src="{{ file_url(directory ~ '/images/logo.jpg') }}" width="150"/>
        <h1 class="mt-4">PHARMACIE</h1>
      </div>

			<div class="row shadow rounded mt-5 fixed-height main-front">
				{% if params.new  %}
					<div class="alert alert-success" role="alert">
						<h4 class="alert-heading">La commande est enregistrée !!</h4>
						<p> {% set com_new = node_parser(params.new )%}
						    Reference commande : {{com_new.title}} <br/>
							Montant total : {{com_new.field_total_vente}} Ar
						</p>
						<hr>
						<p class="mb-0"> Veuillez passer le Reference commande au Caissier pour le paiement</p>
		                <hr>

							<div class="row">
					   <div class="col-md-6">
					         						<a class="btn my-blue mt-2" href="/frontdesk" > Passer un nouveau commande </a>
					   </div>
					   <div class="col-md-6">
					       <a  href="/dashboard" style="float:right"  class="btn mt-2 btn-secondary"> Retour à la plateforme</a>
						</div>
			    </div>
					</div>
                {% else  %}
						<div class="col-md-6">
					<table id="table1" data-search="true" data-single-select="true" data-click-to-select="true" data-search-align="left" data-pagination="true" data-locale="fr-FR" data-thead-classes='head-blue'>
						<thead>
							<tr>
								<th data-field="state" data-checkbox="true"></th>
								<th data-field="id">ID</th>
								<th data-field="name">name</th>
								<th data-field="price">Prix unitaire</th>
								<th data-field="qte">Quantité en stock</th>
							</tr>
						</thead>
					</table>
				</div>
				<div id="toolbar" class="col-md-1 align-content-center">
					<button id="add" class="btn my-blue" disabled>
						<i class="fa fa-plus"></i>
						Ajouter</button>

				</div>
				<div class="col-md-5">
					<div class="mt-2 mb-2 text-center">
						<div class="row">
							<form id="my-form" class="col-md-6 p-0" action="" method="POST">
								<input type="hidden" id="post-data" name="data">
								<select class="js-client-select" id="client" name="client" required>
									<option value="">--- Choisir client ---</option>
									{% for item in  clients|reverse %}
										{% set n = node_parser(item) %}
										<option value="{{ n.nid }}" {% if n.nid == params['client'] %} selected {% endif %}>{{ n.title }}</option>
									{% endfor %}
								</select>
							</form>
							<button id="add-client" class="btn my-blue col-md-5">Ajouter nouveau client</button>
						</div>
					</div>
					<table id="table2" data-toggle="table" data-show-footer="true" data-locale="fr-FR" data-thead-classes='head-blue' data-height="480" data-fixed-scroll="true">
						<thead>
							<tr>
								<th data-field="name">Nom</th>
								<th data-field="price">Prix Unitaire</th>
								<th data-field="qte" data-footer-formatter="nameFormatter">Qte</th>
								<th data-field="price_total" data-footer-formatter="priceFormatter">Prix Total</th>
								<th data-field="id">ID</th>
								<th data-formatter="operateFormatter" data-events="window.operateEvents"></th>
							</tr>
						</thead>
					</table>

				</div>
				<div class="row">
					   <div class="col-md-6"><a  href="/dashboard"  class="btn mt-2 btn-secondary"> Retour à la plateforme</a></div>
					   <div class="col-md-6"><button style="float:right" id="submit-btn" class="btn my-blue mt-2">Enregistrer</button></div>
			    </div>

				{% endif %}

			</div>
		</div>

		 <script>
						var $table1 = $('#table1')
						var $table2 = $('#table2')
						var $add = $('#add')
						var my_data = {
							'items': [],
							'total': 0
						}
						;
						var my_total;

						function operateFormatter(value, row, index) {
							return [
								'<a class="remove" href="javascript:void(0)" title="Remove">',
								'<i class="fa fa-trash"></i>',
								'</a>'
								].join('')
						}

						window.operateEvents = {
							'click .remove': function (e, value, row, index) {
								$table2.bootstrapTable('remove', {
									field: 'id',
									values: [row.id]
								})
								my_data['items'] = my_data['items'].filter(item => item.id !== row.id);
							}
						}

						function getidSelections() {
							return $.map($table1.bootstrapTable('getSelections'), function (row) {
								return row.id
							})
						}

						$(function() {
				    	var data =
							[
				            {% for item in articles|reverse %}
													{% set n = node_parser(item) %}

				                           	{
				                                "id": "{{n.nid}}",
				                                "name": "{{n.title}}",
				                                "price": "{{n.field_prix_unitaire}}",
				                                "qte": "{{n.field_quantite_stock}}"
				                            },
				             {% endfor %}
							]
							$table1.bootstrapTable({data: data})
						})
						$table1.on('check.bs.table uncheck.bs.table ' +
							'check-all.bs.table uncheck-all.bs.table',
							function () {
								$add.prop('disabled', !$table1.bootstrapTable('getSelections').length)
							})
						$add.on('click', function () {
							checked = $table1.bootstrapTable('getSelections')
							$.confirm({
								title: 'Ajouter le nombre de quantité',
								theme: 'modern',
								content: ''+
								'<form action="" class="text-start">' +
								'<strong>Nom: </strong> ' +checked[0].name +'</br><strong>Prix unitaire: </strong> ' +checked[0].price +
								'<div class="row me-0"><div class="col-auto">'+
								'<label for="qte" class="col-form-label">Qte</label>'+
								'</div>'+
								'<div class="col-auto">'+
								'<input type="number" id="qte" class="form-control" min="1" max="' +checked[0].qte +'" data-max="' +checked[0].qte +'" value="1" required>'+
								'</div></div>' +
								'</form>',
								buttons: {
									formSubmit: {
										text: 'Ajouter',
										btnClass: 'btn-blue',
										action: function () {
											var qte = this.$content.find('#qte').val();
											var max = this.$content.find('#qte').data('max');
											if(qte < 1 || qte > max ){
												$.alert('La quantité doit être valide');
												return false;
											}
											$add.prop('disabled',true)
											$table1.bootstrapTable('uncheckBy', {field: 'id', values: [checked[0].id]})
											$table2.bootstrapTable('append', [
											{
												id: checked[0].id,
												name: checked[0].name,
												qte: qte,
												price: checked[0].price,
												price_total: qte*checked[0].price
											}
											])
											my_data['items'].push({'id': checked[0].id, 'qte': qte})
										}
									},
									cancel: function () {

									},
								},
								onContentReady: function () {

									var jc = this;
									this.$content.find('form').on('submit', function (e) {

										e.preventDefault();
				            jc.$$formSubmit.trigger('click'); // reference the button and click it
				        });
								}
							});
						})
						$('#add-client').on('click', function () {
							$.confirm({
								title: 'Ajouter nouveau client',
								theme: 'modern',
								content: ''+
								'<form action="" method="POST" id="new-client-form" class="text-start">' +
								'<div class="row me-0"><div class="col-md-3">'+
								'<label for="name-client" class="col-form-label">Référence<font color="red">*</font></label>'+
								'</div>'+
								'<div class="col-auto">'+
								'<input type="text" class="form-control" id="name-client" name="name" required>'+
								'</div></div>' +
								'<div class="row me-0"><div class="col-md-3">'+
								'<label for="phone" class="col-form-label">Phone</label>'+
								'</div>'+
								'<div class="col-auto mt-1">'+
								'<input type="text" name="phone" class="form-control">'+
								'</div></div>' +
		              '<input type="hidden" name="new_client" value="1">'+
		              '<button class="btn my-blue mt-2" type="submit">Ajouter</button>'+
								'</form>',
		            buttons: {
		              yes: {
		                isHidden: true, // hide the button
		              },
								},
		            backgroundDismiss: true,
		            closeIcon: true,
							});
						})
						function priceFormatter(data) {
							var field = this.field
							my_total = data.map(function (row) {
								return +row[field]
							}).reduce(function (sum, i) {
								return sum + i
							}, 0)
							return my_total
						}

						function nameFormatter(data, footerValue) {
							return 'Total (Ar)'
						}

						$('#submit-btn').on('click', function(){
							if(!my_total || !$('#client').val()){
								return false
							}
							my_data['total'] = my_total
							$('#post-data').val(JSON.stringify(my_data))
		          $('#my-form').submit()

						})
				    $('.js-client-select').select2({
				        width: "90%"
				    });


					</script>
	</body>
</html>
